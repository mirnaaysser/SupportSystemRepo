@model BizSparkSupport.MVC.Areas.Admin.ViewModels.CaseDetailsVM

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "CaseDetails";
}

<div class="container" style="padding-top:20px;">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            @if (Model.Case.StatusID != 1)
            {
                <div class="panel-default">
                    <div class="panel-body">
                        <div class="panel-info" id="TimerCountDown">
                            <div class="panel-heading">Count Down Till DeadLine</div>
                            <div class="clockdiv panel-body">
                                <div>
                                    <span id="days"></span>
                                    <div class="smalltext">Days</div>
                                </div>
                                <div>
                                    <span id="hours"></span>
                                    <div class="smalltext">Hours</div>
                                </div>
                                <div>
                                    <span id="minutes"></span>
                                    <div class="smalltext">Minutes</div>
                                </div>
                                <div>
                                    <span id="seconds"></span>
                                    <div class="smalltext">Seconds</div>
                                </div>
                            </div>
                            <h4 style="color:red;" id="demo"></h4>
                        </div>
                        <div class="panel-info">
                            <div class="panel-heading">Time Passed Since Case Opened</div>
                            <div class="clockdiv panel-body">
                                <div>
                                    <span id="days2"></span>
                                    <div class="smalltext">Days</div>
                                </div>
                                <div>
                                    <span id="hours2"></span>
                                    <div class="smalltext">Hours</div>
                                </div>
                                <div>
                                    <span id="minutes2"></span>
                                    <div class="smalltext">Minutes</div>
                                </div>
                                <div>
                                    <span id="seconds2"></span>
                                    <div class="smalltext">Seconds</div>
                                </div>
                            </div>
                        </div>
                        <style>
                            body {
                                text-align: center;
                                font-family: sans-serif;
                                font-weight: 100;
                            }

                            h1 {
                                color: #396;
                                font-weight: 100;
                                font-size: 40px;
                                margin: 40px 0px 20px;
                            }

                            .clockdiv {
                                font-family: sans-serif;
                                color: #fff;
                                display: inline-block;
                                font-weight: 100;
                                text-align: center;
                                font-size: 30px;
                            }

                                .clockdiv > div {
                                    padding: 10px;
                                    border-radius: 3px;
                                    background: #034f84;
                                    display: inline-block;
                                }

                                .clockdiv div > span {
                                    padding: 15px;
                                    border-radius: 3px;
                                    background: #92a8d1;
                                    display: inline-block;
                                }

                            .smalltext {
                                padding-top: 5px;
                                font-size: 16px;
                            }
                        </style>


                        @section timer{
                            <script>

                                // Set the date we're counting down to
                                var countDownDate = new Date((@ViewBag.Timer));

                                var now = new Date((@ViewBag.ServerTime));
                                //Update the count down every 1 second
                                var x = setInterval(function () {

                                    now.setSeconds(now.getSeconds() + 1);

                                    // Find the distance between now an the count down date
                                    var distance = countDownDate - now;

                                    // Time calculations for days, hours, minutes and seconds
                                    var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                    var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                    var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                    if (days > 0) {
                                        document.getElementById("days").innerHTML = days;
                                    } else document.getElementById("days").innerHTML = 0;
                                    if (hours > 0) {
                                        document.getElementById("hours").innerHTML = hours;
                                    } else document.getElementById("hours").innerHTML = 0;
                                    if (minutes > 0) {
                                        document.getElementById("minutes").innerHTML = minutes;
                                    } else document.getElementById("minutes").innerHTML = 0;
                                    if (seconds > 0) {
                                        document.getElementById("seconds").innerHTML = seconds;
                                    } else document.getElementById("seconds").innerHTML = 0;

                                    
                                    // If the count down is finished, write some text
                                    if (distance < 0) {
                                        clearInterval(x);
                                        document.getElementById("demo").innerHTML = "Expired";
                                    }
                                }, 1000);
                            </script>

                        }
                        @section timer2{
                            <script>
                                // Set the date we're counting down to
                                var countUpDate = new Date((@ViewBag.Timer2));


                                // Update the count down every 1 second
                                    var y = setInterval(function () {

                                    // Find the distance between now an the count down date
                                    var distance = now - countUpDate;

                                    // Time calculations for days, hours, minutes and seconds
                                    var days2 = Math.floor(distance / (1000 * 60 * 60 * 24));
                                    var hours2 = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    var minutes2 = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                    var seconds2 = Math.floor((distance % (1000 * 60)) / 1000);

                                    document.getElementById("days2").innerHTML = days2;
                                    document.getElementById("hours2").innerHTML = hours2;
                                    document.getElementById("minutes2").innerHTML = minutes2;
                                    document.getElementById("seconds2").innerHTML = seconds2;

                                }, 1000);
                            </script>
                        }
                    </div>
                </div>
            }

            <div class="panel-primary">
                @if (TempData["CloseCaseError"] != null)
                {
                    <h5 class="text-danger">@TempData["CloseCaseError"]</h5>
                }
                <div class="panel-heading">
                    @Html.DisplayFor(model => model.Case.Subject)
                </div>

                <div class="panel-body">
                    <table class="table table-striped table-bordered nowrap" cellspacing="0" width="100%">
                        <tr>
                            <td style="font-weight:bold">
                                @Html.DisplayNameFor(model => model.Case.Subject)
                            </td>
                            <td>
                                @Html.DisplayFor(model => model.Case.Subject)
                            </td>
                        </tr>

                        <tr>
                            <td style="font-weight:bold">
                                @Html.DisplayName("Description")
                            </td>
                            <td>
                                @Html.DisplayFor(model => model.Case.Description)
                            </td>
                        </tr>

                        <tr>
                            <td style="font-weight:bold">
                                @Html.DisplayName("Submission Date")
                            </td>
                            <td>
                                @Html.DisplayFor(model => model.Case.SubmissionDate)
                            </td>
                        </tr>

                        @if (Model.Case.StatusID == 1)
                        {
                            <tr>
                                <td style="font-weight:bold">
                                    @Html.DisplayName("Closed At")
                                </td>
                                <td>
                                    @Html.DisplayFor(model => model.Case.ClosedAt)
                                </td>
                            </tr>
                        }
                        <tr>
                            <td style="font-weight:bold">
                                @Html.DisplayName("Category")
                            </td>
                            <td>
                                @Html.DisplayFor(model => model.Case.Category.CategoryName)
                            </td>
                        </tr>

                        <tr>
                            <td style="font-weight:bold">
                                @Html.DisplayName("Priority")
                            </td>
                            <td>
                                @Html.DisplayFor(model => model.Case.Priority.PriorityName)
                            </td>
                        </tr>

                        <tr>
                            <td style="font-weight:bold">
                                @Html.DisplayName("Company")
                            </td>
                            <td>
                                @Html.DisplayFor(model => model.Case.Startup.CompanyName)
                            </td>
                        </tr>

                        <tr>
                            <td style="font-weight:bold">
                                @Html.DisplayName("Status")
                            </td>
                            <td>
                                @Html.DisplayFor(model => model.Case.Status.StatusName)
                            </td>
                        </tr>
                        @if (Model.Content != null)
                        {
                            <tr>
                                <td style="font-weight:bold">
                                    @Html.DisplayName("Files")
                                </td>
                                <td>
                                    <a href="@Url.Action("DownloadFile","Support",new { id = Model.FileID })">Download</a>
                                    @*@Html.DisplayFor(model => model.Status.StatusName)*@
                                </td>
                            </tr>
                        }
                        
                    </table>
                </div>
                <div class="panel-footer">
                    <div class="btn-group">
                        @Html.ActionLink("Go Back", "Dashboard", "Support", null, new { @class = "btn btn-primary" })

                        @if(Model.Case.StatusID == 4)
                        {
                            @Html.ActionLink("Accept", "TakeNewCase", "Support", new { caseId = Model.Case.CaseID }, new { @class = "btn btn-info" })
                        }
                        else if (Model.Case.StatusID == 2)
                        {
                            @*@Html.ActionLink("Close", "CloseCase", "Support", new { caseId = Model.Case.CaseID }, new { @class = "btn btn-success" })*@
                            <a class="btn btn-success" data-toggle="modal" data-target="#closecaseconfirmmodal">Close</a>

                            @Html.ActionLink("Escalate", "EscalateCase", "Support", new { caseId = Model.Case.CaseID }, new { @class = "btn btn-danger"})
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#LeaveMessage">Leave A Message</button>
                            @*download file*@
                            @*@Html.ActionLink("Close", "CloseCase", "Support", new { caseId = Model.CaseID }, new { @class = "btn btn-success" })*@

                        }
                        
                        @*@Html.ActionLink("See Messages History", "Messages", "Support", new { caseId = Model.Case.CaseID }, new { @class = "btn btn-primary" })*@
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br> <br>
    <div class="col-md-8 col-md-offset-2">
        <div class="panel-success">
            <div class="panel-heading">Case Messages </div>
            <div class="panel-body">
                @Html.Partial("MessagesPartial", Model.MessagesModel)
            </div>

        </div>
    </div>
    <br> <br>

</div>

<!-- Modal -->

<div class="modal fade" id="closecaseconfirmmodal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">Close Case</div>
            <div class="modal-body">
                <h4>Are You Sure you want to close this case?</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <a href="@Url.Action("CloseCase", "Support",new { caseId = Model.Case.CaseID })" class="btn btn-danger btn-danger">Close</a>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="LeaveMessage" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Send Message</h4>
            </div>
            <div class="modal-body">
                @{ var data = new BizSparkSupport.DAL.Message { ReceiverID = Model.Case.StartupID , CaseID = Model.Case.CaseID }; }
                @Html.Partial("LeaveMessage", data)
            </div>
        </div>
    </div>
</div>
